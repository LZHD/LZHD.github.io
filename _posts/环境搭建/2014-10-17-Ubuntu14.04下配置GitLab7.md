---
layout : life
title: Ubuntu14.04下搭建GitLab7服务器
category : 环境搭建
duoshuo: true
date : 2017-04-13
---

```
	author : daodaoliang@yeah.net
	date : 2017-04-13
	version : 0.0.4
```

<!-- more -->

### 1.采用Omnibus方式安装

******

根据[官网地址][1]，选择 ubuntu 14.04 然后执行相应命令，即可完成安装操作，注意：

* 如果你用虚拟机，就直接用迅雷搞定，然后再拖进去吧，毕竟180M
* 在安装邮件相关时注意

```
sudo apt-get install postfix # Select 'Internet Site', using sendmail instead also works, exim has problems
```

  平时没有看注释的习惯，现在你也要看下，在安装postfix的时候，会让你选择模式，这时候需要选择 **Internet Site** 模式

******

### 2.初步配置

******

当你按照提示安装好后，基本上就可以使用了，但是在使用的过程中，我们发现邮件通知功能不稳定，使用

```sh
sudo vi /var/log/mail.log
```

查看后发现，邮件被当成了垃圾邮件，被退信了。
使用sendmail这种方式发信，貌似被退信的几率比较高，因此我们需修改一下，毕竟邮件通知还是很重要的。
我们注册一个邮箱账号，让GitLab通过该账号向我们发送邮件通知，这看起来就像两个人正常通信了，基本上就不会被退信了。

******

### 3.注册邮箱

******

163邮箱不解释，记住用户名密码即可

******

### 4.继续配置

******

根据[配置教程][2]
里面详细说明了如何对GitLab进行各种配置，比如 LDAP 、邮件之类的。
修改发送邮件步骤如下：

```sh
sudo vi /etc/gitlab/gitlab.rb
```

增加如下配置项，例:

```
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.exmail.qq.com"
gitlab_rails['smtp_port'] = 465
gitlab_rails['smtp_user_name'] = "youraccount"
gitlab_rails['smtp_password'] = "yourPWD"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = true
gitlab_rails['gitlab_email_from'] = 'youraccount'
```

修改完成后，需要执行以下命令使生效:

```sh
gitlab-ctl reconfigure.
```

### 5.Gitlab 运维

#### 5.1 管理

```
# 启动所有 gitlab 组件：
sudo gitlab-ctl start

# 停止所有 gitlab 组件：
sudo gitlab-ctl stop

# 重启所有 gitlab 组件：
sudo gitlab-ctl restart
```

#### 5.2 备份

备份GitLab repositories and GitLab metadata

在 crontab 中加入如下命令：

```
0 2 * * * /usr/bin/gitlab-rake gitlab:backup:create
```

#### 5.3 恢复

首先进入备份 gitlab 的目录，这个目录是配置文件中的`gitlab_rails['backup_path']` ，默认为 `/var/opt/gitlab/backups` 。

然后停止 `unicorn 和 sidekiq` ，保证数据库没有新的连接，不会有写数据情况。

```
sudo gitlab-ctl stop unicorn
# ok: down: unicorn: 0s, normally up
sudo gitlab-ctl stop sidekiq
# ok: down: sidekiq: 0s, normally up
```

然后恢复数据，1406691018为备份文件的时间戳

```
gitlab-rake gitlab:backup:restore BACKUP=1406691018
```

[1]:https://www.gitlab.com.cn/downloads
[2]:https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md#emails-are-not-being-delivered
